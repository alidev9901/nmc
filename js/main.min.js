"use strict";

let toTop = document.getElementById('to-top');
let hamburger = document.querySelectorAll('.hamburber-btn');
let nav = document.querySelector('.mobile-nav');
let search_form_btn = document.querySelector('.header__search-btn');
let search_block = document.querySelector('.header__search');
let brand_product_slider = document.querySelector('.brand-product__wrap');
let cats_dropdown = document.querySelector('.category-list__dropdown-ico');
let cats_bottom = document.querySelector('.category-list__bottom');
let product_nav_curr = document.querySelector('.product-nav__item__curr');
let get_offer_btn = document.querySelectorAll('.page-nav__offer-btn');
let modal = document.querySelector('.modal');
let pageNavDropdownBtn = document.querySelectorAll('.page-nav__dropdown-btn');
let pageNavList = document.querySelectorAll('.page-nav__list');
let pageNavLink = document.querySelectorAll('.page-nav__link');
const videoPlay = document.querySelectorAll('.video__play');

window.onscroll = function() {myFunction()};


if( toTop ) {

  window.addEventListener('scroll', function() {

    scrollFunction()

  });

  toTop.addEventListener('click', function() {
    
    document.documentElement.scrollTo({
      top: 0,
      behavior: "smooth"
    });

  });


}

function scrollFunction() {
  if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
    toTop.classList.add('active');
  } else {
    toTop.classList.remove('active');
  }
}

/* =============================== Video =============================== */

if(videoPlay.length) {
  videoPlay.forEach(function(button) {
    button.addEventListener('click', function() {
      const parent = button.closest('.video__item');
      if(parent.classList.contains('video__source--youtube')) {
        let iframe = parent.querySelector('iframe');
        let src = iframe.getAttribute('src');
        iframe.setAttribute('src', src += "?autoplay=1");
      } else {
        let video = videoSource.querySelector('video');
        parent.classList.add('video-cover--playing')
        video.play();
      }
      parent.classList.add('video__item--playing');
    });
  });
}


function myFunction() {
  let header = document.querySelector(".header");
  let sticky = header.offsetTop + 30;
  if (window.pageYOffset > sticky) {
    header.classList.add("sticky");
  } else {
    header.classList.remove("sticky");
  }
}

const mobileNavSlider = new Swiper('.mobile-nav__slider', {
  slidesPerView: 4,
  grabCursor: true,
  loop: true,
  autoHeight: true,
  slidesPerView: 'auto',
  spaceBetween: 0,
  breakpoints: {
    0: {
      centeredSlides: true
    },
    576: {
      centeredSlides: false
    }

  }
})


const categoryProductSlider = new Swiper('.category-product__slider', {
  slidesPerView: 4,
  grabCursor: true,
  loop: false,
  slidesPerView: 'auto',
  spaceBetween: 10,
  navigation: {
    nextEl: '.category-product__slider-nav--next',
    prevEl: '.category-product__slider-nav--prev',
  },
  pagination: {
    el: '.category-product__slider-pagination',
    type: 'bullets',
  },
  breakpoints: {
    0: {
      centeredSlides: true
    },
    576: {
      centeredSlides: false,
    }

  },
})

const aboutSlider = new Swiper('.about__brand-slider', {
  slidesPerView: 1,
  grabCursor: true,
  autoHeight: true,
  loop: true,
  navigation: {
    nextEl: '.about__navigation-button--next',
    prevEl: '.about__navigation-button--prev',
  },
  pagination: {
    el: '.about__pagination',
    type: 'bullets',
    clickable: true
  },
  breakpoints: {
    0: {
      slidesPerView: 1,
    },
    576: {
      slidesPerView: 2,
    },
    768: {
      slidesPerView: 3,
    },
    992: {
      slidesPerView: 4,
    },
    1170: {
      slidesPerView: 5,
      spaceBetween: 5
    }
  }
})


const brandSliderBreakpoint = window.matchMedia( ('(min-width: 767px)') );
let brandSlider;

const breakpointChecker = function () {
  if ( brandSliderBreakpoint.matches === true ) {
    if ( brandSlider !== undefined ) brandSlider.destroy(true, true);
    return;
  } else if ( brandSliderBreakpoint.matches === false ) {
    return enableSwiper();
  }


}

const enableSwiper = function () {
  brandSlider = new Swiper ('.brand-product__slider', {
    loop: true,
    slidesPerView: 'auto',
    centerMode: true,
    keyboardControl: true,
    grabCursor: true,
    slidesPerView: 2,

  });

}

brandSliderBreakpoint.addListener(breakpointChecker);
breakpointChecker();



$(window).on('resize orientationchange', function() {
  if(window.innerWidth > 1200) {
    if($('.mobile-nav').hasClass('mobile-nav--active')) {
      $('.mobile-nav').removeClass('mobile-nav--active');
      $('.header__bottom').removeClass('header__bottom--active');
      $(hamburger).removeClass('hamburber-btn--active');
      $('body').removeClass('fixed-position');
      $('.header__logo').removeClass('logo-fixed');
    }
  }

});

if(hamburger) {
  hamburger.forEach(function(button) {
    button.addEventListener('click', function() {
      this.classList.toggle('hamburber-btn--active');
      if( this.classList.contains('tablet') ) {
        $('.header__bottom').toggleClass('header__bottom--active');
      } else {
        nav.classList.toggle('mobile-nav--active');
      }
      $('body').toggleClass('fixed-position');
      $('.header__logo').toggleClass('logo-fixed');
    });
  });

}

if(search_form_btn) {
  search_form_btn.addEventListener('click', function() {
    this.classList.toggle('header__search-btn--active');
    search_block.classList.toggle('header__search--active');
  });
}

if(cats_dropdown) {
  cats_dropdown.addEventListener('click', function(e) {
    e.preventDefault();
    this.classList.toggle('category-list__dropdown-ico--active');
    $('.category-list__bottom').slideToggle();
  });
}


window.addEventListener("resize", function() {
  if(cats_bottom) {
    if(window.innerWidth > 768 && cats_bottom.hasAttribute('style')) {
      cats_bottom.removeAttribute('style');
      cats_dropdown.classList.toggle('category-list__dropdown-ico--active');
    };
  }
});


document.addEventListener("DOMContentLoaded", function(event) {
  $(".page-nav__list").on("click","a", function (event) {
    event.preventDefault();
    var id  = $(this).attr('href'),
        top = $(id).offset().top;
    $('body,html').animate({scrollTop: top}, 1000);
  });
});

document.addEventListener('click', function(event) {
  
  const dropdownContainers = document.querySelectorAll('.dropdown-container');

  if( dropdownContainers ) {

    dropdownContainers.forEach(function(dropdownContainer) {
      if (window.innerWidth >= 1170  && dropdownContainer && !dropdownContainer.contains(event.target)) {

        $(dropdownContainer).find('.dropdown--active').removeClass('dropdown--active').find('.dropdown__submenu').slideToggle()
      }
    });

  }


  

});


get_offer_btn.forEach(function(e) {
  e.addEventListener('click', function() {
    modal.classList.toggle('modal--active');
  });
});

$('.dropdown__button').on('click', function() {


    $('.dropdown--active').not($(this).closest('.dropdown')).removeClass('dropdown--active').find('.dropdown__submenu').slideToggle()

    if( $(this).closest('.dropdown').find('.dropdown--active').length ) {
      $(this).closest('.dropdown').find('.dropdown--active').not($(this).closest('.dropdown')).removeClass('dropdown--active').find('.dropdown__submenu').slideToggle()
    }

    $(this).closest('.dropdown').toggleClass('dropdown--active')
    $(this).closest('.dropdown').find('.dropdown__submenu').slideToggle();


    
});

$('.modal__close-btn').on('click', function () {
  $(this).parents('.modal--active').removeClass('modal--active');
});

if(modal) {
  modal.addEventListener('click', function(e) {
    if(e.target == this) {
      modal.classList.toggle('modal--active');
    }
  });
}

pageNavLink.forEach(function(e) {
  e.addEventListener('click', function() {
    if(e.parentElement.parentElement.classList.contains('page-nav__list--active')) {
      e.parentElement.parentElement.classList.remove('page-nav__list--active');
      e.parentElement.parentElement.previousElementSibling.firstElementChild.classList.remove('page-nav__dropdown-btn--active');
    }
  });
});

pageNavDropdownBtn.forEach(function(e) {
  e.addEventListener('click', function() {
    e.classList.toggle('page-nav__dropdown-btn--active');
    e.parentElement.nextElementSibling.classList.toggle('page-nav__list--active');
  })
});

$(document).on('submit','#feedback__form',function(e){
  e.preventDefault();
});


( function () {
  'use strict';

  // Флаг, что Метрика уже загрузилась.
  var loadedMetrica = false,
      // Ваш идентификатор сайта в Яндекс.Метрика.
      metricaId     = 86811321,
      // Переменная для хранения таймера.
      timerId;

  // Для бота Яндекса грузим Метрику сразу без "отложки",
  // чтобы в панели Метрики были зелёные кружочки
  // при проверке корректности установки счётчика.
  if ( navigator.userAgent.indexOf( 'YandexMetrika' ) > -1 ) {
    loadMetrica();
  } else {
    // Подключаем Метрику, если юзер начал скроллить.
    window.addEventListener( 'scroll', loadMetrica, {passive: true} );

    // Подключаем Метрику, если юзер коснулся экрана.
    window.addEventListener( 'touchstart', loadMetrica );

    // Подключаем Метрику, если юзер дернул мышкой.
    document.addEventListener( 'mouseenter', loadMetrica );

    // Подключаем Метрику, если юзер кликнул мышкой.
    document.addEventListener( 'click', loadMetrica );

    // Подключаем Метрику при полной загрузке DOM дерева,
    // с "отложкой" в 1 секунду через setTimeout,
    // если пользователь ничего вообще не делал (фоллбэк).
    document.addEventListener( 'DOMContentLoaded', loadFallback );
  }

  function loadFallback() {
    timerId = setTimeout( loadMetrica, 3000 );
  }

  function loadMetrica( e ) {

    // Пишем отладку в консоль браузера.
    if ( e && e.type ) {
      console.log( e.type );
    } else {
      console.log( 'DOMContentLoaded' );
    }

    // Если флаг загрузки Метрики отмечен,
    // то ничего более не делаем.
    if ( loadedMetrica ) {
      return;
    }

    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)}; m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)}) (window, document, "script", "https://cdn.jsdelivr.net/npm/yandex-metrica-watch/tag.js", "ym");
    ym( metricaId, "init", { clickmap:true, trackLinks:true, accurateTrackBounce:true });

    // Отмечаем флаг, что Метрика загрузилась,
    // чтобы не загружать её повторно при других
    // событиях пользователя и старте фоллбэка.
    loadedMetrica = true;

    // Очищаем таймер, чтобы избежать лишних утечек памяти.
    clearTimeout( timerId );

    // Отключаем всех наших слушателей от всех событий,
    // чтобы избежать утечек памяти.
    window.removeEventListener( 'scroll', loadMetrica );
    window.removeEventListener( 'touchstart', loadMetrica );
    document.removeEventListener( 'mouseenter', loadMetrica );
    document.removeEventListener( 'click', loadMetrica );
    document.removeEventListener( 'DOMContentLoaded', loadFallback );
  }
} )()


$(document).ready(function(){
  $(document).on('click', '.useful__events-more', function(){
    loadMore('.useful__events-content', '.useful__events-more', '.useful__event');
  });
  $(document).on('click', '#article-more', function(){
    loadMore('.useful__articles', '#article-more', '.useful__article');
  });
});

function loadMore(containerClass, moreBtnClass, elementClass) {
  let targetContainer = $(containerClass),
      url =  $(moreBtnClass).attr('data-url');
  if (url !== undefined) {
    $.ajax({
      type: 'GET',
      url: url,
      dataType: 'html',
      success: function(data){
        const loadMoreText = $(moreBtnClass).text();
        $(moreBtnClass).text('Загрузка...');
        setTimeout(function () {
          $(moreBtnClass).remove();
          let elements = $(data).find(elementClass),
              pagination = $(data).find(moreBtnClass);
          targetContainer.append(elements);
          targetContainer.append(pagination);
          $(moreBtnClass).text(loadMoreText);
        }, 1500)
      }
    })
  }
}